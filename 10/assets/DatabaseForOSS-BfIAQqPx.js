var u=Object.defineProperty;var g=(a,e,t)=>e in a?u(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var r=(a,e,t)=>g(a,typeof e!="symbol"?e+"":e,t);import{O as d}from"./ali-oss-Ci4CXxfL.js";import{$ as p}from"./vendor-C-jb08-1.js";import{H as f}from"./index-420onEHt.js";import{E as l,a as m}from"./element-plus-SGNFsUZO.js";import"./@vue-BYKpmgQC.js";import"./cos-js-sdk-v5-p1FWqW2f.js";import"./@element-plus-DmmXDu5M.js";class k{constructor(){r(this,"fileNames",{store:"password-xl/store.json",setting:"password-xl/setting.json",note:"password-xl/note.json"});r(this,"fileEtags",{});r(this,"ossClient",null);r(this,"region",null);r(this,"bucket",null)}async login(e){try{return this.ossClient=new d({region:e.region,accessKeyId:e.accessKeyId,accessKeySecret:e.accessKeySecret,bucket:e.bucket,secure:!0}),this.region=e.region,this.bucket=e.bucket,Promise.resolve({status:!0})}catch(t){return Promise.reject({status:!1,message:t})}}async getStoreData(){return this.getFile(this.fileNames.store)}async setStoreData(e){return this.uploadFile(this.fileNames.store,e)}async getTreeNoteData(){return this.getFile(this.fileNames.note)}async setNoteData(e){return this.uploadFile(this.fileNames.note,e)}async getData(e){return this.getFile(e)}async setData(e,t){return this.uploadFile(e,t)}async deleteStoreData(){return this.deleteFile(this.fileNames.store)}async getSettingData(){return this.getFile(this.fileNames.setting)}async setSettingData(e){return this.uploadFile(this.fileNames.setting,e)}async deleteSettingData(){return this.deleteFile(this.fileNames.setting)}async deleteData(e){return this.deleteFile(e)}async uploadImage(e,t){return new Promise((i,s)=>{if(!this.ossClient)throw new Error("oss uploadFile 存储引擎不存在");let c=e.name.split(".").pop(),o="/images/"+t+"/"+f()+"."+c;const n={"x-oss-object-acl":"public-read"};this.ossClient.put(o,e,{headers:n}).then(async()=>{i("https://"+this.bucket+"."+this.region+".aliyuncs.com"+o)}).catch(h=>{l.error({title:"系统异常",message:this.errorDispose(h)}),s({status:!1,message:this.errorDispose(h)})})})}async getFile(e){return new Promise((t,i)=>{if(!this.ossClient)throw new Error("oss getFile 存储引擎不存在");this.ossClient.get(e).then(s=>{this.updateEtag(e,JSON.parse(JSON.stringify(s.res.headers))["last-modified"]),t(s.content.toString())}).catch(s=>{s&&s.status===404?t(""):(l.error({title:"系统异常",message:this.errorDispose(s)}),i({status:!1,message:this.errorDispose(s)}))})})}async uploadFile(e,t){return new Promise(async(i,s)=>{if(!this.ossClient)throw new Error("oss uploadFile 存储引擎不存在");if(!await this.checkEtag(e)){m({title:"文件同步异常",message:"当前密码列表已被其他客户端更新，请刷新页面",showCancelButton:!1,showConfirmButton:!0,closeOnPressEscape:!1,showClose:!1,closeOnClickModal:!1,confirmButtonText:"刷新",callback:()=>{location.reload()}});return}let o=p.Buffer.from(t);this.ossClient.put(e,o).then(async()=>{await this.updateEtag(e),i({status:!0})}).catch(n=>{l.error({title:"系统异常",message:this.errorDispose(n)}),s({status:!1,message:this.errorDispose(n)})})})}async deleteFile(e){return new Promise((t,i)=>{if(!this.ossClient)throw new Error("oss deleteFile 存储引擎不存在");this.ossClient.delete(e).then(()=>{t({status:!0})}).catch(s=>{l.error({title:"系统异常",message:this.errorDispose(s)}),i({status:!1,message:this.errorDispose(s)})})})}errorDispose(e){let t={InvalidAccessKeyId:"账号（AccessKeyId）无效",SignatureDoesNotMatch:"密钥（secretKey）无效",AccessDenied:"该账号无存储桶（bucket）权限或存储桶错误"};if(e.status===-1)return"有可能是存储桶（bucket）不存在、地域（region）错误、跨域配置错误";if(e.status===403){let i=t[e.code];return i||"权限错误"}else return e.message}getEtag(e){return new Promise(async t=>{if(!this.ossClient)throw new Error("oss getEtag 存储引擎不存在");let i=await this.ossClient.head(e),s=JSON.parse(JSON.stringify(i.res.headers))["last-modified"];t(s)})}async checkEtag(e){if(!this.fileEtags[e])return Promise.resolve(!0);let t=await this.getEtag(e);return this.fileEtags[e]===t}async updateEtag(e,t){t||(t=await this.getEtag(e)),this.fileEtags[e]=t}}export{k as DatabaseForOSS};
