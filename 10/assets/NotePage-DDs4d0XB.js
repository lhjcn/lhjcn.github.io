import{M as W,I as X,c as O,J as ee,K as te,a as oe,b as K,O as H,v as ne,S as ae,e as Y,u as se,P as le,T as re,U as ie,V as de}from"./element-plus-SGNFsUZO.js";import{a as F,G,u as q,H as ce,_ as P,I as ue}from"./index-420onEHt.js";import{d as U,r as m,G as z,L as A,c as pe,z as V,u as c,D as r,v as n,a as y,P as fe,B as N,C as Q,o as J,J as me,Q as _e,t as $,x as j,ai as ge}from"./@vue-BYKpmgQC.js";import{_ as ve}from"./logo-B_J9w6Yt.js";import{C as ye}from"./aieditor-YMkC0OXY.js";import{Z as he}from"./vendor-C-jb08-1.js";import"./@element-plus-DmmXDu5M.js";import"./cos-js-sdk-v5-p1FWqW2f.js";import"./ali-oss-Ci4CXxfL.js";const xe={key:0,class:"note-tree"},we=["onContextmenu"],Ne=U({__name:"NoteTree",emits:["activateChange"],setup(L,{expose:k,emit:D}){const g=F(),i=G(),p=m({}),v=q(),_=m(),d=m(!0),o=D,f=m([]),b=t=>{let e={id:ce(),label:"新笔记",children:[]};t?(t.children||(t.children=[]),t.children.push(e)):i.noteData.noteTree.push(e),A(()=>{_.value.setCurrentKey(e.id+""),i.noteData.currentNote=e.id+"",g.noteTitleRef&&g.noteTitleRef.value&&g.noteTitleRef.focus(),v.passwordManager.syncNoteData()})},h=t=>{let e="确认删除“"+t.data.label+"”吗？";t.children&&t.children.length&&(e="确认删除“"+t.data.label+"”及其子目录下的所有笔记吗？"),oe.confirm(e,"删除笔记",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}).then(()=>{E(t)}).catch(()=>{})},C=t=>{const e=(u,I)=>{I.push(u.id);for(let T=0;T<u.children.length;T++)e(u.children[T],I)};let s=[];return e(t.data,s),s},S=(t,e)=>{for(let s=e.length-1;s>=0;s--)e[s].children&&S(t,e[s].children),t.includes(e[s].id)&&e.splice(s,1)},E=t=>{let e=C(t);for(let s=0;s<e.length;s++){let u="note/"+e[s]+".html";v.passwordManager.delData(u),w(e[s])}S(e,i.noteData.noteTree),i.noteData.currentNote&&e.includes(i.noteData.currentNote)&&(i.noteData.currentNote=""),v.passwordManager.syncNoteData(),K.success("删除成功")},l=(t,e)=>{t.stopPropagation();for(let s in p.value)p.value[s]&&p.value[s].handleClose()},a=t=>{i.noteData.currentNote!==t.id&&(i.noteData.currentNote=t.id,o("activateChange",t),v.passwordManager.syncNoteData())},x=t=>{f.value.push(t),localStorage.setItem("expandKeys",JSON.stringify(f.value))},w=t=>{f.value=f.value.filter(e=>e!==t),localStorage.setItem("expandKeys",JSON.stringify(f.value))};return z(()=>{f.value=JSON.parse(localStorage.getItem("expandKeys")||"[]"),d.value=!1,A(()=>{if(i.noteData.currentNote){_.value.setCurrentKey(i.noteData.currentNote);let t=_.value.getCurrentNode();t&&o("activateChange",t)}})}),k({addNote:b}),(t,e)=>{const s=O,u=te,I=ee,T=X,Z=W;return c(d)?V("",!0):(J(),pe("div",xe,[r(Z,{ref_key:"treeRef",ref:_,data:c(i).noteData.noteTree,"default-expanded-keys":c(f),"expand-on-click-node":!1,draggable:"","highlight-current":"","node-key":"id",style:{"max-width":"600px"},onNodeExpand:e[0]||(e[0]=M=>x(M.id)),onNodeCollapse:e[1]||(e[1]=M=>w(M.id)),onCurrentChange:a,onNodeDrop:e[2]||(e[2]=()=>c(v).passwordManager.syncNoteData())},{default:n(({node:M,data:R})=>[r(T,{ref:B=>c(p)[R.id]=B,style:{width:"100%"},trigger:"contextmenu"},{dropdown:n(()=>[r(I,{style:{width:"100px"}},{default:n(()=>[r(u,{onClick:B=>b(R)},{default:n(()=>e[3]||(e[3]=[y("span",{class:"iconfont icon-create more-item",style:{color:"rgb(0 147 255)"}},null,-1),N(" 新笔记 ")])),_:2},1032,["onClick"]),r(u,{onClick:B=>h(M)},{default:n(()=>e[4]||(e[4]=[y("span",{class:"iconfont icon-delete more-item",style:{color:"rgb(255,23,23)","font-size":"130%"}},null,-1),N(" 删除 ")])),_:2},1032,["onClick"])]),_:2},1024)]),default:n(()=>[y("div",{class:"node-class",onContextmenu:B=>l(B,R.id)},[r(s,{style:fe([{color:c(i).noteData.currentNote===R.id?"#409EFF":""},{width:"85%"}]),truncated:""},{default:n(()=>[N(Q(R.label),1)]),_:2},1032,["style"])],40,we)]),_:2},1536)]),_:1},8,["data","default-expanded-keys"])]))}}}),De=P(Ne,[["__scopeId","data-v-b9dc6d3c"]]),Ce={style:{display:"flex","justify-content":"space-between"}},ke=U({__name:"NoteEditor",setup(L,{expose:k}){const D=F(),g=m(!0),i=m(),p=m(""),v=G(),_=q();let d=null;const o=m({id:"",name:"",content:"",updateTime:0});function f(l){l.preventDefault(),l.returnValue=""}const b=l=>{o.value.id&&(h(),p.value=""),g.value=!0,_.passwordManager.getData("note/"+l.id+".html").then(a=>{a?o.value=JSON.parse(a):o.value={id:l.id,name:l.label,content:"",updateTime:Date.now()},p.value=JSON.stringify(o.value),S(o.value.content),g.value=!1})},h=(l=!1)=>{if(o.value.id){if(!o.value.name){K.error("请输入标题");return}if(p.value===JSON.stringify(o.value)){l&&K.success("保存成功");return}o.value.updateTime=Date.now(),p.value=JSON.stringify(o.value),_.passwordManager.setData("note/"+o.value.id+".html",p.value).then(()=>{l&&K.success("保存成功");let a=v.getTreeNoteById(o.value.id);a&&(a.label=o.value.name,_.passwordManager.syncNoteData()),window.removeEventListener("beforeunload",f)})}},C=m(),S=l=>{d&&d.destroy(),d=new ye({element:i.value,toolbarKeys:["brush","eraser","|","heading","font-family","font-size","|","bold","italic","underline","strike","link","code","subscript","superscript","hr","todo","emoji","|","image","highlight","font-color","|","align","line-height","bullet-list","ordered-list","|","quote","code-block","container","table","source-code"],textSelectionBubbleMenu:{enable:!0,items:["Bold","Italic","Underline","Strike","code","comment"]},image:{uploader:a=>new Promise(x=>{_.passwordManager.uploadImage(a,o.value.id).then(w=>{x({errorCode:0,data:{src:w,alt:a.name}})}).catch(w=>{x({errorCode:-1})})})},placeholder:"点击输入内容...",content:l,onChange:a=>{o.value.content=a.getHtml(),window.addEventListener("beforeunload",f),C.value&&clearTimeout(C.value),C.value=setTimeout(()=>{h()},500)}})},E=l=>{l.ctrlKey&&l.key.toUpperCase()==="S"&&(l.preventDefault(),h(!0))};return me(()=>{d&&d.destroy()}),z(()=>{document.addEventListener("keydown",E)}),_e(()=>{document.removeEventListener("keydown",E)}),k({showNote:b}),(l,a)=>{const x=O,w=Y,t=ae,e=H,s=ne;return c(v).noteData.currentNote?(J(),$(e,{key:0,class:"editor-card",shadow:"never",style:{height:"calc(100% - 2px)"}},{header:n(()=>[y("div",Ce,[j(y("input",{ref:u=>c(D).noteTitleRef=u,"onUpdate:modelValue":a[0]||(a[0]=u=>c(o).name=u),class:"title-input",placeholder:"请输入标题"},null,512),[[ge,c(o).name]]),r(x,null,{default:n(()=>[N("最后更新于："+Q(c(he)(c(o).updateTime).format("YYYY-MM-DD HH:mm:ss")),1)]),_:1}),r(t,{size:"large"},{default:n(()=>[r(w,{plain:"",size:"small",type:"primary",onClick:a[1]||(a[1]=u=>h(!0))},{default:n(()=>a[2]||(a[2]=[N("保存")])),_:1})]),_:1})])]),default:n(()=>[j(y("div",{ref_key:"editorRef",ref:i,"element-loading-text":"加载中，别急",style:{height:"calc(100vh - 66px)"}},null,512),[[s,c(g)]])]),_:1})):V("",!0)}}}),be=P(ke,[["__scopeId","data-v-408ac17d"]]),Se={style:{height:"calc(100% - 2px)",display:"flex","flex-direction":"column"}},Ee={style:{display:"flex","justify-content":"space-between"}},Te={style:{display:"flex","align-items":"center"}},Me=U({__name:"NotePage",setup(L){const k=m(),D=m(!1),g=m(),i=()=>{ue.push("/")},p=d=>{k.value.addNote(d)},v=d=>{g.value.showNote(d)},_=()=>{D.value=!1,localStorage.setItem("firstNote","1")};return z(()=>{localStorage.getItem("firstNote")||(D.value=!0)}),(d,o)=>{const f=se,b=O,h=le,C=Y,S=De,E=H,l=re,a=ie,x=de;return J(),$(x,{class:"note-container"},{default:n(()=>[r(l,{class:"mask",style:{"margin-right":"6px"},width:"310px"},{default:n(()=>[y("div",Se,[c(D)?(J(),$(f,{key:0,style:{"margin-bottom":"12px"},type:"warning",onClose:_},{default:n(()=>o[1]||(o[1]=[N(" 笔记内容未使用主密码加密，请注意安全 ")])),_:1})):V("",!0),r(E,{shadow:"never",style:{width:"calc(100% - 2px)",flex:"1"}},{header:n(()=>[y("div",Ee,[r(b,{style:{"font-size":"18px",color:"#444"}},{default:n(()=>o[2]||(o[2]=[N("目录")])),_:1}),y("div",Te,[r(h,{content:"密码管理"},{default:n(()=>[y("img",{alt:"",src:ve,style:{height:"30px","margin-right":"10px",cursor:"pointer"},onClick:i})]),_:1}),r(h,{content:"添加笔记"},{default:n(()=>[r(C,{circle:"",class:"note-btn",plain:"",type:"primary",onClick:o[0]||(o[0]=w=>p())},{default:n(()=>o[3]||(o[3]=[N(" + ")])),_:1})]),_:1})])])]),default:n(()=>[r(S,{ref_key:"noteTreeRef",ref:k,onActivateChange:v},null,512)]),_:1})])]),_:1}),r(a,{class:"mask",style:{"margin-left":"6px"}},{default:n(()=>[r(be,{ref_key:"noteEditorRef",ref:g},null,512)]),_:1})]),_:1})}}}),ze=P(Me,[["__scopeId","data-v-2b92dc7e"]]);export{ze as default};
